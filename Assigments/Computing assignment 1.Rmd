---
title: "Computing Assignment 1"
author: "Alyssa Vanderbeek"
date: "9/29/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("~/Desktop/FALL 2019/Bayesian Design/P8133_BayesianAnalysis_AdaptiveDesign/fns.R")
```

## Question 1

```{r Bayesian_nogo_sims}
### Prior distribution of null and alternative response rates
n1 = 20
s1 = 6
ntotal = 71 # total sample size
s2 = 24 # futility interim
N = 10e4

a.s = 25 # prior a for control 
b.s = 75 # prior b for control
ps = rbeta(N, a.s, b.s) # simulate control responses from prior

a = 0.5
b = 1.5
a_cond.total = a + s2 # prior a for exp conditional on s
b_cond.total = b + ntotal - s2 # prior b for exp conditional on s
pe.total = rbeta(N, a_cond.total, b_cond.total) # simulate exp responses from prior
# a_cond.interim = a + s1 # prior a for exp conditional on s
# b_cond.interim = b + n1 - s1 # prior b for exp conditional on s
# pe.interim = rbeta(N, a_cond.interim, b_cond.interim) # simulate exp responses from prior
```

```{r}
#### Find delta, alpha to satisfy decision boundary
d = 0.15 # seq(0, 0.2, 0.01)[-1]
alpha = seq(0, 1, 0.05)[-1]

### 1. For given delta, find alpha s.t. s = 24 gives a "go" decision
t = sum(pe.total > (ps + d)) / N # left side of Bayesian decision rule
# take only those values of alpha for which s=22 lends a "go" decision
alpha = alpha[(which((t > alpha) == TRUE))]; alpha 

### 2. For alphas that satisfy 1, find the subset that satisfy "go" for s=24 AND "no-go" for s=23
## go/no-go decision for s=24
t1 = sum(pe.total > (ps + d)) / N 

## go/no-go decision for s=23
s2.no = s2 - 1
a_cond = a + s2.no
b_cond = b + ntotal - s2.no

pe = rbeta(N, a_cond, b_cond)
t2 = sum(pe > (ps + d)) / N; t2 > alpha 

## go/no-go decision for s=23
s1.no = s1 - 1
a_cond = a + s1.no
b_cond = b + n1 - s1.no

pe = rbeta(N, a_cond, b_cond)
t3 = sum(pe > (ps + d)) / N; t3 > alpha 

## Verify that the selected alpha makes the decision boundary s = 24
index = Reduce(intersect, list(which((t1 > alpha) == TRUE), 
                               which((t2 > alpha) == FALSE),
                               which((t3 > alpha) == FALSE)))
alpha.test = alpha[index] # new alphas

### 3. Verify that final selected alpha(s) satisfy decision boundary
## This should be a "go" decision
s2.no = s2
a_cond = a + s2.no
b_cond = b + ntotal - s2.no
pe = rbeta(N, a_cond, b_cond)
t1 = sum(pe > (ps + d)) / N; t1 > alpha.test

## This should be a "no-go" decision
s2.no = s2 - 1
a_cond = a + s2.no
b_cond = b + ntotal - s2.no
pe = rbeta(N, a_cond, b_cond)
t2 = sum(pe > (ps + d)) / N; t2 > alpha.test 

## This should be a "no-go" decision
s1.no = s1 - 1
a_cond = a + s1.no
b_cond = b + n1 - s1.no
pe = rbeta(N, a_cond, b_cond)
t3 = sum(pe > (ps + d)) / N; t3 > alpha.test 


c(d, alpha.test)
```


The two-stage adaptive design as described in lecture is as follows: stage 1 enrolls 20 patients. At the interim, we stop the trial and conclude futility if less than 6 subjects respond. Otherwise, we continue onto stage 2 and enroll an additional 51 subjects for a total sample size of 71 subjects. At the end of the trial, we conclude futility ("no-go") if fewer than 24 subjects respond, and conclude efficacy ("go") if at least 24 subjects respond. 

To mimic this design in the Bayesian formulation, we can set $(\delta, \alpha)$ = (`r d`, `r alpha.test`), which gives a "go" decision for 24 responses, and a no-go decision for either 5/20 or 23/71 responses.


## Problem 2

