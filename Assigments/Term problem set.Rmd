---
title: "Term problem set"
author: "Alyssa Vanderbeek (amv2187)"
date: "2 December 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

R code used for computation is given at the end of the document.


### Problem 1: (Preliminaries) For a randomized, placebo-controlled study of a statin for lowering LDL, we consider a reduction in LDL by 10mg=dL on average to be clinically meaningful, whereas patients in the placebo will experience no change on average. Assume that the variance of LDL is equal to 20mg=dL at both baseline and the 3-month follow-up in both groups.

### a. What additional information or assumption(s) do you need to calculate a sample size?

### b. State the assumptions you make and calculate the sample size required for a two-sided test at 5\% significance.



### Problem 2: (Go/no-go) In a two-stage trial of an experimental treatment with a planned futility interim analysis, 14 patients are first enrolled and treated in the first stage. An additional of 20 patients will be enrolled and treated if there is at least 1 response in the first stage. At the end of the trial, the treatment is deemed promising ("go") when there are at least 4 responses in all enrolled patients.

### a. Suppose the true response rate is 5\%. What is the expected value of the sample size?
```{r}
p = 0.05
n1 = 14
e1 = 1
ntotal = 34
e2 = 4
n2 = ntotal - n1

# P(stopping at stage 1 | p = 0.05)
x = pbinom(e1 - 1, n1, p) # 0.48

# Expected sample size
n_expected = ceiling(n1*x + ntotal*(1 - x)) # 24.24

```

For a true response rate of 5\%, the expected sample size of the trial is 25 subjects. 

### b. Suppose the true response rate is 5\%. Evaluate the probability of a "go" decision.
```{r}
f = c()
for (i in e1:n1) {
  f[i] = dbinom(i, n1, p) * (1 - pbinom(e2 - i - 1, n2, p))
}
pgo1 = sum(f, na.rm = T)
```

The probability of a "go" decision is given by 
\begin{align*}
Pr(go) &= Pr(S_{14} \geq 1, S_{34} \geq 4 | p = 0.05) \\
&= ... = \Sigma_{n=1}^{14} [Pr(S_14 = n|p = 0.05) * \Sigma_{m = n}^{34} [Pr(S_{20} 
\geq 4-m | p = 0.05)]].
\end{align*}

For a true response rate of 5\%, the probability of a "go" decision is ~0.08.

### c. Suppose the true response rate is 20\%. Evaluate the probability of a "go" decision.
```{r}
p = 0.2
f = c()
for (i in e1:n1) {
  f[i] = dbinom(i, n1, p) * (1 - pbinom(e2 - i - 1, n2, p))
}
pgo2 = sum(f, na.rm = T)
```

Using the same formulation for calculating $Pr(go)$ as above, for a true response rate of 20\%, the probability of making a "go" decision is ~0.90.

### d. Using your result in (b) as type I error rate and (c) as power, evaluate the sample size required for a fixed design with null response 5\% and alternative response 20\%.
```{r}
p0 = 0.05
p1 = 0.2
alpha = pgo1
power = pgo2

ss = list()
for (i in 1:50) {
  n = i
  s = seq(1, i, 1)
  
  t1 = 1 - pbinom(s - 1, n, p0)
  pow = 1 - pbinom(s - 1, n, p1)
  index = intersect(which(t1 <= alpha), which(pow >= power))
  
  if (length(index) == 0) {
    ss[[i]] = NA
  } else {
    ss[[i]] = c(s[index[1]], n)
  }
}

n = ss[which(!is.na(ss))[1]][2]
s = ss[which(!is.na(ss))[1]][1]


```

Setting type I error to 0.08 and power to 0.90, we find that the sample size required for a fixed design is `r n` subjects, for which we reject the null in favor of the alternative when we see a response from at least `r s`. 


## Problem 3: (Predictive distribution) Suppose X1 follows an exponential distribution with rate .

### a. Give a conjugate prior for Derive its posterior distribution and the corresponding prior predictive distribution of X1.

### b. Suppose X1 and X2 are exchangeable. Derive the posterior predictive distribution of X2 given X1.

### c. Derive the posterior predictive distribution of (X1 + X2)/2 given X1.


## Problem 4: Suppose the toxicity probability of dose level 1 is 0.25. Calculate the probability that the 3+3 algorithm will declare dose level 1 safe (i.e., below the MTD).

```{r 3plus3_function}
# p.true = vector of true DLT probabilities for each test dose
# n.dose = number (integer) of test doses
# N = number of simulations to run
performance_3plus3 <- function(p.true, n.dose, N){
  results = vector(mode = "list", length = N)
  
  for (sim in 1:N) {
    pt = 1 # patient on dose k
    n = 1 # patient on trial
    dose = 1 # dose k
    esc = 1 # escalation yes/no
    mtd = 0 # MTD
    
    dlts = vector(mode = 'list', length = n.dose)
    
    while (esc == 1 && dose <= n.dose && pt <= 6) {
      dlts[[dose]][pt] = rbinom(1, 1, p.true[dose])
      
      # If <3 pts enrolled on current dose, enroll next pt on same dose
      if (length(dlts[[dose]]) < 3) {
        pt = pt + 1
        n = n + 1
        dose = dose
        # If 1/3 pts on current dose observe DLT, enroll next 3 patients on same dose
      } else if (sum(dlts[[dose]]) == 1 && length(dlts[[dose]]) == 3) {
        pt = pt + 1
        n = n + 1
        dose = dose
        # If 0/3 pts on current dose observe DLT, escalate dose
      } else if (sum(dlts[[dose]]) == 0 && length(dlts[[dose]]) == 3) {
        pt = 1
        mtd = dose
        dose = dose + 1
        n = n + 1
        # If <=1 patient out of 3-6 observe DLT, stay at same dose
      } else if (sum(dlts[[dose]]) <= 1 && length(dlts[[dose]]) > 3 && length(dlts[[dose]]) < 6) {
        pt = pt + 1
        n = n + 1
        mtd = dose
        dose = dose
        # If we observe 0/6 DLT, escalate dose
      } else if (sum(dlts[[dose]]) == 0 && length(dlts[[dose]]) == 6) {
        pt = 1
        n = n + 1
        mtd = dose
        dose = dose + 1
        # If we observe 1/6 DLTs, stop escalation and declare this dose level the MTD
      } else if (sum(dlts[[dose]]) == 1 && length(dlts[[dose]]) == 6) {
        esc = 0 # MTD
        mtd = dose
        # If we observe 2 DLTs at the current dose level, stop the trial and declare the previous dose the MTD
      } else if (sum(dlts[[dose]]) > 1) {
        esc = 0 
        mtd = dose - 1
      } else {
        dlts[[dose]][pt] = NA # reassign entry as NA in case of error
      }
    }
    
    results[[sim]] = list(dlts = unlist(lapply(dlts, sum)),
                          nperdose = unlist(lapply(dlts, length)),
                          n = n,
                          mtd = mtd)
  }
  return(results)
}
```


```{r}
N = 1e3

set.seed(1)
sims = performance_3plus3(0.025, 1, N)

mtd.1 = unlist(lapply(sims, `[[`, 4))
mean(mtd.1)
```

The 3+3 design will declare the dose safe with probability `r mean(mtd.1)`.

## Problem 5: 


```{r}
# p.true = c(0.02, 0.04, 0.10, 0.25, 0.50)
# n.dose = length(p.true)
# N = 1e3
# 
# set.seed(1)
# sims = performance_3plus3(0.025, 1, N)
# 
# mtd = unlist(lapply(sims, `[[`, 4))
# mean(mtd.1)
```


## Problem 6

```{r}
library(dfcrm)
target = 0.1
prior = c(0.05, 0.12, 0.25, 0.40, 0.55)
trueP = c(0.02, 0.04, 0.10, 0.25, 0.50)
N = 20
crmoutput = crmsim(trueP, prior, target, N, 3, model="logistic")
crmoutput$MTD
```

## Problem 7

```{r}
crm.sim = crmsim(PI = trueP, prior = prior, target = target, n = N, x0 = 3, nsim = 10)
crm.sim$MTD
```


\pagebreak

## R code

```{r, eval=FALSE}

```

